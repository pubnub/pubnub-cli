{"version":3,"sources":["networking.js"],"names":["request","require","_","process","env","NODE_TLS_REJECT_UNAUTHORIZED","endpoint","logger","method","url","opts","callback","join","json","headers","err","response","body","statusCode","error","pick","_prepareErrorResponse","debug","ownerId","sessionToken","qs","owner_id","keyId","blockId","blockPayload","form","eventHandlerPayload","eventHandlerId","email","password","constructedError","message","errorCode","error_code"],"mappings":"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","file":"networking.js","sourcesContent":["const request = require('request');\nconst _ = require('lodash');\n\n// this is a fix for bad SSL cert on portal gold\nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;\n\nexport default class {\n\n  constructor({ endpoint, logger }) {\n    this.logger = logger;\n    this.endpoint = endpoint;\n  }\n\n  request(method, url, opts, callback) {\n    opts = opts || {};\n\n    opts.url = this.endpoint + '/' + url.join('/');\n    opts.method = method;\n\n    opts.json = true;\n    opts.headers = opts.headers || {};\n\n    request(opts, (err, response, body) => {\n      if (response.statusCode !== 200 || err) {\n        this.logger.error('HTTP Request Failed', { method, url, opts, err, response: _.pick(response, 'end'), body });\n        callback(this._prepareErrorResponse({ err, response, body }));\n      } else {\n        this.logger.debug('HTTP Request Successful', { method, url, opts, err, response });\n        callback(null, body);\n      }\n    });\n  }\n\n  getApps({ ownerId, sessionToken }, callback) {\n    if (!ownerId) return callback('missing ownerId');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { qs: { owner_id: ownerId }, headers: { 'X-Session-Token': sessionToken } };\n    this.request('get', ['api', 'apps'], opts, callback);\n  }\n\n  getBlocks({ keyId, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { headers: { 'X-Session-Token': sessionToken } };\n    this.request('get', ['api', 'v1', 'blocks', 'key', keyId, 'block'], opts, callback);\n  }\n\n  startBlock({ keyId, blockId, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { headers: { 'X-Session-Token': sessionToken } };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'start'], opts, callback);\n  }\n\n  stopBlock({ keyId, blockId, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { headers: { 'X-Session-Token': sessionToken } };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'stop'], opts, callback);\n  }\n\n  createBlock({ keyId, blockPayload, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload, headers: { 'X-Session-Token': sessionToken } };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block'], opts, callback);\n  }\n\n  updateBlock({ keyId, blockId, blockPayload, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload, headers: { 'X-Session-Token': sessionToken } };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId], opts, callback);\n  }\n\n  createEventHandler({ keyId, eventHandlerPayload, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload, headers: { 'X-Session-Token': sessionToken } };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler'], opts, callback);\n  }\n\n  updateEventHandler({ keyId, eventHandlerId, eventHandlerPayload, sessionToken }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerId) return callback('missing eventHandlerId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload, headers: { 'X-Session-Token': sessionToken } };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler', eventHandlerId], opts, callback);\n  }\n\n  createLoginToken({ email, password }, callback) {\n    if (!email) return callback('missing email');\n    if (!password) return callback('missing password');\n\n    const opts = { form: { email, password } };\n    this.request('post', ['api', 'me'], opts, callback);\n  }\n\n  _prepareErrorResponse({ err, response, body }) {\n    const constructedError = {\n      statusCode: null,\n      message: null,\n      errorCode: null\n    };\n\n    if (response && response.statusCode) {\n      constructedError.statusCode = response.statusCode;\n    }\n\n    if (body) {\n      if (body.error) constructedError.message = body.error;\n      if (body.error_code) constructedError.errorCode = body.error_code;\n    } else {\n      constructedError.message = err;\n    }\n\n    return constructedError;\n  }\n}\n"]}