{"version":3,"sources":["networking.js"],"names":["request","require","colors","process","env","NODE_TLS_REJECT_UNAUTHORIZED","endpoint","logLevel","newSessionToken","sessionToken","method","url","opts","callback","join","json","headers","Authorization","pendingNetworking","JSON","stringify","state","console","log","gray","err","response","body","statusCode","red","_prepareErrorResponse","green","ownerId","qs","owner_id","keyId","blockId","blockPayload","form","eventHandlerPayload","eventHandlerId","email","password","constructedError","message","errorCode","error","error_code"],"mappings":"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","file":"networking.js","sourcesContent":["const request = require('request');\nconst colors = require('colors/safe');\n\n// this is a fix for bad SSL cert on portal gold\nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;\n\nexport default class {\n\n  constructor({ endpoint, logLevel }) {\n    this.logLevel = logLevel;\n    this.endpoint = endpoint;\n  }\n\n  updateSessionToken(newSessionToken) {\n    this.sessionToken = newSessionToken;\n  }\n\n  request(method, url, opts, callback) {\n    opts = opts || {};\n\n    opts.url = this.endpoint + '/' + url.join('/');\n    opts.method = method;\n\n    opts.json = true;\n    opts.headers = opts.headers || {};\n    opts.headers.Authorization = 'Basic cHVibnViLWJldGE6YmxvY2tzMjAxNg===';\n\n    if (this.sessionToken) {\n      opts.headers['X-Session-Token'] = this.sessionToken;\n    }\n\n    if (this.logLevel === 'debug') {\n      const pendingNetworking = JSON.stringify({ state: 'pending', method, url, opts }, null, 2);\n      console.log('\\n', colors.gray(pendingNetworking), '\\n'); // eslint-disable-line no-console\n    }\n\n    request(opts, (err, response, body) => {\n      if (response.statusCode !== 200 || err) {\n        if (this.logLevel === 'debug') {\n          const pendingNetworking = JSON.stringify({ state: 'failed', method, url, opts, err, response, body }, null, 2);\n          console.log('\\n', colors.red(pendingNetworking), '\\n'); // eslint-disable-line no-console\n        }\n\n        callback(this._prepareErrorResponse({ err, response, body }));\n      } else {\n        if (this.logLevel === 'debug') {\n          const pendingNetworking = JSON.stringify({ state: 'success', method, url, opts, err, response }, null, 2);\n          console.log('\\n', colors.green(pendingNetworking), '\\n'); // eslint-disable-line no-console\n        }\n\n        callback(null, body);\n      }\n    });\n  }\n\n  getApps({ ownerId }, callback) {\n    if (!ownerId) return callback('missing ownerId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { qs: { owner_id: ownerId } };\n    this.request('get', ['api', 'apps'], opts, callback);\n  }\n\n  getBlocks({ keyId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('get', ['api', 'v1', 'blocks', 'key', keyId, 'block'], {}, callback);\n  }\n\n  startBlock({ keyId, blockId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'start'], {}, callback);\n  }\n\n  stopBlock({ keyId, blockId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'stop'], {}, callback);\n  }\n\n  createBlock({ keyId, blockPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block'], opts, callback);\n  }\n\n  updateBlock({ keyId, blockId, blockPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId], opts, callback);\n  }\n\n  createEventHandler({ keyId, eventHandlerPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler'], opts, callback);\n  }\n\n  updateEventHandler({ keyId, eventHandlerId, eventHandlerPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerId) return callback('missing eventHandlerId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler', eventHandlerId], opts, callback);\n  }\n\n  createLoginToken({ email, password }, callback) {\n    if (!email) return callback('missing email');\n    if (!password) return callback('missing password');\n\n    const opts = { form: { email, password } };\n    this.request('post', ['api', 'me'], opts, callback);\n  }\n\n  _prepareErrorResponse({ err, response, body }) {\n    const constructedError = {\n      statusCode: null,\n      message: null,\n      errorCode: null\n    };\n\n    if (response && response.statusCode) {\n      constructedError.statusCode = response.statusCode;\n    }\n\n    if (body) {\n      if (body.error) constructedError.message = body.error;\n      if (body.error_code) constructedError.errorCode = body.error_code;\n    } else {\n      constructedError.message = err;\n    }\n\n    return constructedError;\n  }\n}\n"],"sourceRoot":"/source/"}