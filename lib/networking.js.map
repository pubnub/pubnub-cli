{"version":3,"sources":["networking.js"],"names":["request","require","process","env","NODE_TLS_REJECT_UNAUTHORIZED","logger","endpoint","newSessionToken","sessionToken","method","url","opts","callback","join","json","headers","err","response","body","statusCode","logFailedNetworkEvent","_prepareErrorResponse","logSuccessfulNetworkEvent","ownerId","qs","owner_id","keyId","blockId","blockPayload","form","eventHandlerPayload","eventHandlerId","email","password","constructedError","message","errorCode","error","error_code"],"mappings":"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","file":"networking.js","sourcesContent":["const request = require('request');\n\n// this is a fix for bad SSL cert on portal gold\nprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;\n\nexport default class {\n\n  constructor({ logger }, { endpoint }) {\n    this.logger = logger;\n    this.endpoint = endpoint;\n  }\n\n  updateSessionToken(newSessionToken) {\n    this.sessionToken = newSessionToken;\n  }\n\n  request(method, url, opts, callback) {\n    opts = opts || {};\n\n    opts.url = this.endpoint + '/' + url.join('/');\n    opts.method = method;\n\n    opts.json = true;\n    opts.headers = opts.headers || {};\n\n    if (this.sessionToken) {\n      opts.headers['X-Session-Token'] = this.sessionToken;\n    }\n\n    request(opts, (err, response, body) => {\n      if (response.statusCode !== 200 || err) {\n        this.logger.logFailedNetworkEvent({ method, url, opts, err, response, body });\n        callback(this._prepareErrorResponse({ err, response, body }));\n      } else {\n        this.logger.logSuccessfulNetworkEvent({ method, url, opts, err, response });\n        callback(null, body);\n      }\n    });\n  }\n\n  getApps({ ownerId }, callback) {\n    if (!ownerId) return callback('missing ownerId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { qs: { owner_id: ownerId } };\n    this.request('get', ['api', 'apps'], opts, callback);\n  }\n\n  getBlocks({ keyId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('get', ['api', 'v1', 'blocks', 'key', keyId, 'block'], {}, callback);\n  }\n\n  startBlock({ keyId, blockId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'start'], {}, callback);\n  }\n\n  stopBlock({ keyId, blockId }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId, 'stop'], {}, callback);\n  }\n\n  createBlock({ keyId, blockPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'block'], opts, callback);\n  }\n\n  updateBlock({ keyId, blockId, blockPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!blockId) return callback('missing blockId');\n    if (!blockPayload) return callback('missing blockPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: blockPayload };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'block', blockId], opts, callback);\n  }\n\n  createEventHandler({ keyId, eventHandlerPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload };\n    this.request('post', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler'], opts, callback);\n  }\n\n  updateEventHandler({ keyId, eventHandlerId, eventHandlerPayload }, callback) {\n    if (!keyId) return callback('missing keyId');\n    if (!eventHandlerId) return callback('missing eventHandlerId');\n    if (!eventHandlerPayload) return callback('missing eventHandlerPayload');\n    if (!this.sessionToken) return callback('missing sessionToken');\n\n    const opts = { form: eventHandlerPayload };\n    this.request('put', ['api', 'v1', 'blocks', 'key', keyId, 'event_handler', eventHandlerId], opts, callback);\n  }\n\n  createLoginToken({ email, password }, callback) {\n    if (!email) return callback('missing email');\n    if (!password) return callback('missing password');\n\n    const opts = { form: { email, password } };\n    this.request('post', ['api', 'me'], opts, callback);\n  }\n\n  _prepareErrorResponse({ err, response, body }) {\n    const constructedError = {\n      statusCode: null,\n      message: null,\n      errorCode: null\n    };\n\n    if (response && response.statusCode) {\n      constructedError.statusCode = response.statusCode;\n    }\n\n    if (body) {\n      if (body.error) constructedError.message = body.error;\n      if (body.error_code) constructedError.errorCode = body.error_code;\n    } else {\n      constructedError.message = err;\n    }\n\n    return constructedError;\n  }\n}\n"],"sourceRoot":"/source/"}