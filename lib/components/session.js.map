{"version":3,"sources":["components/session.js"],"names":["logger","networking","interactive","sessionStorage","homedir","userId","sessionToken","abstractedPromise","Promise","fulfill","_fetchSessionFile","then","credentials","catch","error","info","getApps","ownerId","err","result","green","red","resolve","sessionValid","undefined","reject","email","password","inputParams","field","name","question","type","fields","createLoginToken","serverResponse","user_id","token","_createSessionFile","_deleteSessonFile","readFile","data","JSON","parse","writeFile","stringify","unlink","code"],"mappings":"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","file":"session.js","sourcesContent":["import os from 'os';\nimport fs from 'fs';\nimport colors from 'colors/safe';\nimport { createPromise, abstractedValidator } from '../utils';\n\nexport default class {\n\n  constructor({ logger, networking, interactive = false }) {\n    this.logger = logger;\n    this.networking = networking;\n    this.sessionStorage = os.homedir() + '/.pubnub-cli';\n    this.interactive = interactive;\n  }\n\n  checkSession({ userId, sessionToken } = {}) {\n    const abstractedPromise = createPromise();\n\n    // abstract CLI // API\n    new Promise((fulfill) => {\n      if (this.interactive) {\n        this._fetchSessionFile()\n          .then((credentials) => { fulfill(credentials); })\n          .catch((error) => {\n            this.logger.info('Session does not exist; credentials found failed to load', error);\n            return;\n          });\n      } else {\n        fulfill({ userId, sessionToken });\n      }\n    }).then((credentials) => {\n      this.networking.getApps({ sessionToken: credentials.sessionToken, ownerId: credentials.userId }, (err, result) => {\n        // mask the error by checking the status code.\n        if (this.interactive) {\n          if (result) this.logger.info(colors.green('session is valid'));\n          else this.logger.info(colors.red('session is invalid'));\n        } else {\n          abstractedPromise.resolve({ sessionValid: result !== undefined });\n        }\n      });\n    }).catch((error) => {\n      if (this.interactive) this.logger.error(error);\n      else abstractedPromise.reject(error);\n    });\n\n    return abstractedPromise;\n  }\n\n  createSession({ email, password }) {\n    const abstractedPromise = createPromise();\n    const inputParams = [\n      {\n        field: email,\n        name: 'email',\n        question: 'Please enter your PubNub email',\n        type: 'input'\n      },\n      {\n        field: password,\n        name: 'password',\n        question: 'Please enter your PubNub password',\n        type: 'password'\n      }\n    ];\n\n    abstractedValidator(inputParams, this.interactive).then((fields) => {\n      this.networking.createLoginToken({ email: fields.email, password: fields.password }, (err, serverResponse) => {\n        if (err) {\n          if (this.interactive) this.logger.error(err);\n          else abstractedPromise.reject(err);\n          return;\n        }\n\n        const userId = serverResponse.result.user_id;\n        const sessionToken = serverResponse.result.token;\n\n        if (this.interactive) {\n          this._createSessionFile({ userId, sessionToken }).then(() => {\n            this.logger.info('Login Succesful, token: ' + sessionToken + ' saved to home directory');\n          });\n        }\n      });\n    }).catch((err) => {\n      if (this.interactive) this.logger.error(err);\n      else abstractedPromise.reject(err);\n      return;\n    });\n\n    return abstractedPromise;\n  }\n\n  deleteSession() {\n    return this._deleteSessonFile().then(() => {\n      if (this.interactive) this.logger.info('PubNub Session Deleted');\n    });\n  }\n\n  _fetchSessionFile() {\n    return new Promise((resolve) => {\n      fs.readFile(this.sessionStorage, 'utf8', (err, data) => {\n        if (err) resolve({}); else resolve(JSON.parse(data));\n      });\n    });\n  }\n\n  _createSessionFile({ sessionToken, userId }) {\n    return this._deleteSessonFile().then(() => {\n      return new Promise((resolve, reject) => {\n        fs.writeFile(this.sessionStorage, JSON.stringify({ sessionToken, userId }), (err) => {\n          if (err) reject(err); else resolve();\n        });\n      });\n    });\n  }\n\n  _deleteSessonFile() {\n    return new Promise((resolve, reject) => {\n      fs.unlink(this.sessionStorage, (err) => {\n        // silence file not found\n        if (err && err.code !== 'ENOENT') reject(err); else resolve();\n      });\n    });\n  }\n\n}\n"]}