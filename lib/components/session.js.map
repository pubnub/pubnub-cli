{"version":3,"sources":["components/session.js"],"names":["logger","networking","interactive","sessionStorage","homedir","email","password","inputParams","field","name","question","type","abstractedPromise","createPromise","abstractedValidator","then","fields","createLoginToken","err","serverResponse","error","reject","token","result","_createSessionFile","info","catch","successResolve","failureResolve","promise","Promise","fulfill","resolve","params","response","validationPassing","questions","forEach","param","trim","push","message","length","prompt","promptResult","Object","assign","_deleteSessonFile","readFile","data","sessionToken","writeFile","unlink","code"],"mappings":"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","file":"session.js","sourcesContent":["import os from 'os';\nimport fs from 'fs';\nimport inquirer from 'inquirer';\nimport _ from 'lodash';\n\nexport default class {\n\n  constructor({ logger, networking, interactive = false }) {\n    this.logger = logger;\n    this.networking = networking;\n    this.sessionStorage = os.homedir() + '/.pubnub-cli';\n    this.interactive = interactive;\n  }\n\n  createSession({ email, password }) {\n    const inputParams = [\n      {\n        field: email,\n        name: 'email',\n        question: 'Please enter your PubNub email',\n        type: 'input'\n      },\n      {\n        field: password,\n        name: 'password',\n        question: 'Please enter your PubNub password',\n        type: 'password'\n      }\n    ];\n\n    const abstractedPromise = this.createPromise();\n\n    this.abstractedValidator(inputParams).then((fields) => {\n      this.networking.createLoginToken({ email: fields.email, password: fields.password }, (err, serverResponse) => {\n        if (err) {\n          if (this.interactive) this.logger.error(err);\n          else abstractedPromise.reject(err);\n          return;\n        }\n\n        const token = serverResponse.result.token;\n\n        if (this.interactive) {\n          this._createSessionFile(token).then(() => {\n            this.logger.info('Login Succesful, token: ' + token + ' saved to home directory');\n          });\n        }\n      });\n    }).catch((err) => {\n      if (this.interactive) this.logger.error(err);\n      else abstractedPromise.reject(err);\n      return;\n    });\n\n    return abstractedPromise;\n  }\n\n  createPromise() {\n    let successResolve;\n    let failureResolve;\n    const promise = new Promise((fulfill, reject) => {\n      successResolve = fulfill;\n      failureResolve = reject;\n    });\n\n    return { promise, reject: failureResolve, resolve: successResolve };\n  }\n\n  abstractedValidator(params = []) {\n    const response = {};\n    let validationPassing = true; // optimism.\n    const questions = [];\n\n    params.forEach((param) => {\n      if (param.field && _.trim(param.field) !== '') {\n        response[param.name] = _.trim(param.field);\n      } else if (this.interactive) {\n        questions.push({ type: param.type, name: param.name, message: param.question });\n      } else {\n        validationPassing = false;\n      }\n    });\n\n    return new Promise((resolve, reject) => {\n      if (this.interactive) {\n        if (questions.length === 0) return resolve(response);\n\n        inquirer.prompt(questions).then((promptResult) => {\n          Object.assign(response, promptResult);\n          resolve(response);\n        });\n      } else {\n        if (validationPassing) resolve(response);\n        else reject(/* TODO */);\n        return;\n      }\n    });\n  }\n\n  deleteSession() {\n    return this._deleteSessonFile().then(() => {\n      if (this.interactive) this.logger.info('PubNub Session Deleted');\n    });\n  }\n\n  _fetchSessionFile() {\n    return new Promise((resolve) => {\n      fs.readFile(this.sessionStorage, 'utf8', (err, data) => {\n        if (err) this.logger.error(err);\n        resolve(data);\n      });\n    });\n  }\n\n  _createSessionFile(sessionToken) {\n    return this._deleteSessonFile().then(() => {\n      return new Promise((resolve) => {\n        fs.writeFile(this.sessionStorage, sessionToken, (err) => {\n          if (err) this.logger.error(err);\n          resolve();\n        });\n      });\n    });\n  }\n\n  _deleteSessonFile() {\n    return new Promise((resolve) => {\n      fs.unlink(this.sessionStorage, (err) => {\n        // silence file not found\n        if (err && err.code !== 'ENOENT') this.logger.error(err);\n        resolve();\n      });\n    });\n  }\n\n}\n"]}