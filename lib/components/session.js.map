{"version":3,"sources":["components/session.js"],"names":["logger","networking","interactive","sessionStorage","homedir","userId","sessionToken","abstractedPromise","Promise","fulfill","_fetchSessionFile","then","credentials","catch","error","info","getApps","ownerId","err","result","green","red","resolve","sessionValid","undefined","reject","promise","checkSession","pick","createSession","response","email","password","inputParams","field","name","question","type","fields","createLoginToken","serverResponse","user_id","token","_createSessionFile","_deleteSessonFile","readFile","data","JSON","parse","writeFile","stringify","unlink","code"],"mappings":"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","file":"session.js","sourcesContent":["import os from 'os';\nimport fs from 'fs';\nimport colors from 'colors/safe';\nimport _ from 'lodash';\nimport { createPromise, abstractedValidator } from '../utils';\n\nexport default class {\n\n  constructor({ logger, networking, interactive = false }) {\n    this.logger = logger;\n    this.networking = networking;\n    this.sessionStorage = os.homedir() + '/.pubnub-cli';\n    this.interactive = interactive;\n  }\n\n  checkSession({ userId, sessionToken } = {}) {\n    const abstractedPromise = createPromise();\n\n    // abstract CLI // API\n    new Promise((fulfill) => {\n      if (this.interactive) {\n        this._fetchSessionFile()\n          .then((credentials) => { fulfill(credentials); })\n          .catch((error) => {\n            this.logger.info('Session does not exist; credentials found failed to load', error);\n            return;\n          });\n      } else {\n        fulfill({ userId, sessionToken });\n      }\n    }).then((credentials) => {\n      this.networking.getApps({ sessionToken: credentials.sessionToken, ownerId: credentials.userId }, (err, result) => {\n        // mask the error by checking the status code.\n        if (this.interactive) {\n          if (result) this.logger.info(colors.green('session is valid'));\n          else this.logger.info(colors.red('session is invalid'));\n        }\n\n        abstractedPromise.resolve({ sessionValid: result !== undefined, sessionToken: credentials.sessionToken, userId: credentials.userId });\n      });\n    }).catch((error) => {\n      if (this.interactive) this.logger.error(error);\n      return abstractedPromise.reject(error);\n    });\n\n    return abstractedPromise.promise;\n  }\n\n  validateOrCreateSession() {\n    const abstractedPromise = createPromise();\n\n    this.checkSession()\n      .then((result) => {\n        if (result.sessionValid) {\n          abstractedPromise.resolve(_.pick(result, 'sessionToken', 'ownerId'));\n        } else {\n          this.createSession()\n            .then((response) => {\n              abstractedPromise.resolve(_.pick(response, 'sessionToken', 'ownerId'));\n            })\n            .catch((err) => {\n              abstractedPromise.reject(err);\n            });\n        }\n      })\n      .catch((error) => {\n        this.logger.error(error);\n        abstractedPromise.reject(error);\n      });\n\n\n    return abstractedPromise.promise;\n  }\n\n  createSession({ email, password } = {}) {\n    const abstractedPromise = createPromise();\n    const inputParams = [\n      {\n        field: email,\n        name: 'email',\n        question: 'Please enter your PubNub email',\n        type: 'input'\n      },\n      {\n        field: password,\n        name: 'password',\n        question: 'Please enter your PubNub password',\n        type: 'password'\n      }\n    ];\n\n    abstractedValidator(inputParams, this.interactive).then((fields) => {\n      this.networking.createLoginToken({ email: fields.email, password: fields.password }, (err, serverResponse) => {\n        if (err) {\n          if (this.interactive) this.logger.error(err);\n          return abstractedPromise.reject(err);\n        }\n\n        const userId = serverResponse.result.user_id;\n        const sessionToken = serverResponse.result.token;\n\n        if (this.interactive) {\n          this._createSessionFile({ userId, sessionToken }).then(() => {\n            this.logger.info('Login Succesful, token: ' + sessionToken + ' saved to home directory');\n          });\n        }\n\n        abstractedPromise.resolve({ sessionToken, userId });\n      });\n    }).catch((err) => {\n      if (this.interactive) this.logger.error(err);\n      return abstractedPromise.reject(err);\n    });\n\n    return abstractedPromise.promise;\n  }\n\n  deleteSession() {\n    return this._deleteSessonFile().then(() => {\n      if (this.interactive) this.logger.info('PubNub Session Deleted');\n    });\n  }\n\n  _fetchSessionFile() {\n    return new Promise((resolve) => {\n      fs.readFile(this.sessionStorage, 'utf8', (err, data) => {\n        if (err) resolve({}); else resolve(JSON.parse(data));\n      });\n    });\n  }\n\n  _createSessionFile({ sessionToken, userId }) {\n    return this._deleteSessonFile().then(() => {\n      return new Promise((resolve, reject) => {\n        fs.writeFile(this.sessionStorage, JSON.stringify({ sessionToken, userId }), (err) => {\n          if (err) reject(err); else resolve();\n        });\n      });\n    });\n  }\n\n  _deleteSessonFile() {\n    return new Promise((resolve, reject) => {\n      fs.unlink(this.sessionStorage, (err) => {\n        // silence file not found\n        if (err && err.code !== 'ENOENT') reject(err); else resolve();\n      });\n    });\n  }\n\n}\n"]}